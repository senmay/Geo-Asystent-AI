<!DOCTYPE html>
<html lang="pl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Instrukcja Dodawania Warstw GIS - Geo-Asystent AI</title>
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            line-height: 1.6;
            color: #333;
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
            background-color: #f8f9fa;
        }
        
        .container {
            background: white;
            padding: 30px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        
        h1 {
            color: #2c3e50;
            text-align: center;
            border-bottom: 3px solid #3498db;
            padding-bottom: 10px;
            margin-bottom: 30px;
        }
        
        h2 {
            color: #34495e;
            border-left: 4px solid #3498db;
            padding-left: 15px;
            margin-top: 30px;
        }
        
        h3 {
            color: #2980b9;
            margin-top: 25px;
        }
        
        .step {
            background: #ecf0f1;
            padding: 20px;
            margin: 15px 0;
            border-radius: 8px;
            border-left: 5px solid #3498db;
        }
        
        .step-number {
            background: #3498db;
            color: white;
            width: 30px;
            height: 30px;
            border-radius: 50%;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            margin-right: 10px;
        }
        
        pre {
            background: #2c3e50;
            color: #ecf0f1;
            padding: 15px;
            border-radius: 5px;
            overflow-x: auto;
            font-size: 14px;
            line-height: 1.4;
        }
        
        code {
            background: #e8f4f8;
            padding: 2px 6px;
            border-radius: 3px;
            font-family: 'Courier New', monospace;
            color: #2c3e50;
        }
        
        .highlight {
            background: #fff3cd;
            border: 1px solid #ffeaa7;
            padding: 15px;
            border-radius: 5px;
            margin: 15px 0;
        }
        
        .warning {
            background: #f8d7da;
            border: 1px solid #f5c6cb;
            color: #721c24;
            padding: 15px;
            border-radius: 5px;
            margin: 15px 0;
        }
        
        .success {
            background: #d4edda;
            border: 1px solid #c3e6cb;
            color: #155724;
            padding: 15px;
            border-radius: 5px;
            margin: 15px 0;
        }
        
        .file-path {
            background: #e9ecef;
            padding: 8px 12px;
            border-radius: 4px;
            font-family: monospace;
            border-left: 3px solid #6c757d;
            margin: 10px 0;
        }
        
        table {
            width: 100%;
            border-collapse: collapse;
            margin: 20px 0;
        }
        
        th, td {
            border: 1px solid #ddd;
            padding: 12px;
            text-align: left;
        }
        
        th {
            background-color: #3498db;
            color: white;
        }
        
        tr:nth-child(even) {
            background-color: #f2f2f2;
        }
        
        .emoji {
            font-size: 1.2em;
            margin-right: 8px;
        }
        
        .toc {
            background: #f8f9fa;
            padding: 20px;
            border-radius: 8px;
            margin: 20px 0;
            border: 1px solid #dee2e6;
        }
        
        .toc ul {
            list-style-type: none;
            padding-left: 0;
        }
        
        .toc li {
            margin: 8px 0;
            padding-left: 20px;
        }
        
        .toc a {
            text-decoration: none;
            color: #2980b9;
        }
        
        .toc a:hover {
            text-decoration: underline;
        }
        
        @media print {
            body {
                background: white;
                font-size: 12px;
            }
            .container {
                box-shadow: none;
                padding: 0;
            }
            pre {
                background: #f8f9fa;
                color: #333;
                border: 1px solid #ddd;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <h1><span class="emoji">üó∫Ô∏è</span>Instrukcja Dodawania Warstw GIS<br>
        <small style="color: #7f8c8d; font-size: 0.6em;">Geo-Asystent AI - System ZarzƒÖdzania Warstwami</small></h1>
        
        <div class="toc">
            <h3><span class="emoji">üìã</span>Spis Tre≈õci</h3>
            <ul>
                <li><a href="#wprowadzenie">1. Wprowadzenie</a></li>
                <li><a href="#krok1">2. Dodanie warstwy do PostGIS</a></li>
                <li><a href="#krok2">3. Konfiguracja w GISRepository</a></li>
                <li><a href="#krok3">4. Rozpoznawanie nazw warstwy</a></li>
                <li><a href="#krok4">5. Stylowanie w frontend</a></li>
                <li><a href="#krok5">6. Automatyczne ≈Çadowanie</a></li>
                <li><a href="#przyklad">7. Przyk≈Çad kompletny</a></li>
                <li><a href="#testowanie">8. Testowanie</a></li>
                <li><a href="#troubleshooting">9. RozwiƒÖzywanie problem√≥w</a></li>
            </ul>
        </div>

        <section id="wprowadzenie">
            <h2><span class="emoji">üéØ</span>1. Wprowadzenie</h2>
            <p>Dziƒôki nowej architekturze z warstwƒÖ repository, dodanie nowej warstwy do PostGIS jest teraz znacznie prostsze i bardziej systematyczne. System automatycznie obs≈Çuguje:</p>
            <ul>
                <li><strong>Rozpoznawanie jƒôzyka</strong> - polskie i angielskie nazwy warstw</li>
                <li><strong>Automatyczne API</strong> - endpoint dostƒôpny od razu</li>
                <li><strong>Fallback na pe≈ÇnƒÖ rozdzielczo≈õƒá</strong> - je≈õli tabela _low nie istnieje</li>
                <li><strong>Obs≈Çuga b≈Çƒôd√≥w</strong> - przyjazne komunikaty po polsku</li>
                <li><strong>Logowanie operacji</strong> - wszystkie operacje sƒÖ monitorowane</li>
            </ul>
        </section>

        <section id="krok1">
            <div class="step">
                <h2><span class="step-number">1</span><span class="emoji">üóÉÔ∏è</span>Dodaj warstwƒô do bazy danych PostGIS</h2>
                <p>Najpierw dodaj swojƒÖ nowƒÖ warstwƒô do bazy danych PostGIS. Mo≈ºesz to zrobiƒá na kilka sposob√≥w:</p>
                
                <h3>Opcja A: U≈ºywajƒÖc QGIS</h3>
                <ol>
                    <li>Otw√≥rz QGIS i po≈ÇƒÖcz siƒô z bazƒÖ PostGIS</li>
                    <li>PrzeciƒÖgnij plik shapefile do QGIS</li>
                    <li>Kliknij prawym przyciskiem ‚Üí Export ‚Üí Save Features As...</li>
                    <li>Wybierz format PostGIS i podaj nazwƒô tabeli</li>
                </ol>

                <h3>Opcja B: U≈ºywajƒÖc ogr2ogr</h3>
                <pre><code># Przyk≈Çad dla pliku shapefile
ogr2ogr -f "PostgreSQL" PG:"host=localhost user=postgres dbname=geo_gis password=password" \
        roads.shp -nln roads -overwrite

# Przyk≈Çad dla pliku GeoJSON  
ogr2ogr -f "PostgreSQL" PG:"host=localhost user=postgres dbname=geo_gis password=password" \
        data.geojson -nln parks -overwrite</code></pre>

                <h3>Opcja C: Bezpo≈õrednio SQL</h3>
                <pre><code>-- Tworzenie tabeli z geometriƒÖ
CREATE TABLE roads (
    id SERIAL PRIMARY KEY,
    name VARCHAR(255),
    road_type VARCHAR(100),
    geometry GEOMETRY(LINESTRING, 2180)
);

-- Dodanie indeksu przestrzennego
CREATE INDEX idx_roads_geom ON roads USING GIST (geometry);</code></pre>
            </div>
        </section>

        <section id="krok2">
            <div class="step">
                <h2><span class="step-number">2</span><span class="emoji">‚öôÔ∏è</span>Konfiguracja w GISRepository</h2>
                
                <div class="file-path">üìÅ backend/repositories/gis_repository.py</div>
                
                <p>Otw√≥rz plik GISRepository i dodaj nowƒÖ warstwƒô do s≈Çownika <code>self.layers</code> w metodzie <code>__init__()</code>:</p>

<pre><code>def __init__(self, db_engine: Engine):
    super().__init__(db_engine)
    
    # Define available layers
    self.layers = {
        "parcels": LayerConfig(
            name="parcels",
            table_name="parcels",
            geometry_column="geometry",
            id_column="ID_DZIALKI",
            display_name="Dzia≈Çki",
            description="Land parcels with ownership information",
            has_low_resolution=True
        ),
        "buildings": LayerConfig(
            name="buildings", 
            table_name="buildings",
            geometry_column="geometry",
            id_column="ID_BUDYNKU",
            display_name="Budynki",
            description="Building footprints",
            has_low_resolution=True
        ),
        "gpz": LayerConfig(
            name="gpz",
            table_name="gpz_110kv",
            geometry_column="geom",
            id_column="id",
            display_name="GPZ 110kV",
            description="Electrical substations 110kV",
            has_low_resolution=False
        ),
        
        # ‚úÖ DODAJ NOWƒÑ WARSTWƒò TUTAJ
        "drogi": LayerConfig(
            name="drogi",
            table_name="roads",              # nazwa tabeli w PostGIS
            geometry_column="geometry",      # nazwa kolumny geometrii
            id_column="road_id",            # nazwa kolumny ID
            display_name="Drogi",           # nazwa wy≈õwietlana
            description="Sieƒá drogowa miejska",
            has_low_resolution=True         # czy ma wersjƒô _low
        )
    }</code></pre>

                <div class="highlight">
                    <h4><span class="emoji">üí°</span>Parametry LayerConfig:</h4>
                    <table>
                        <tr><th>Parametr</th><th>Opis</th><th>Przyk≈Çad</th></tr>
                        <tr><td><code>name</code></td><td>Unikalny identyfikator warstwy</td><td>"drogi"</td></tr>
                        <tr><td><code>table_name</code></td><td>Nazwa tabeli w PostGIS</td><td>"roads"</td></tr>
                        <tr><td><code>geometry_column</code></td><td>Nazwa kolumny z geometriƒÖ</td><td>"geometry", "geom"</td></tr>
                        <tr><td><code>id_column</code></td><td>Nazwa kolumny z ID</td><td>"id", "road_id"</td></tr>
                        <tr><td><code>display_name</code></td><td>Nazwa wy≈õwietlana u≈ºytkownikowi</td><td>"Drogi"</td></tr>
                        <tr><td><code>description</code></td><td>Opis warstwy</td><td>"Sieƒá drogowa"</td></tr>
                        <tr><td><code>has_low_resolution</code></td><td>Czy istnieje tabela _low</td><td>true/false</td></tr>
                    </table>
                </div>
            </div>
        </section>

        <section id="krok3">
            <div class="step">
                <h2><span class="step-number">3</span><span class="emoji">üî§</span>Rozpoznawanie nazw warstwy</h2>
                
                <p>W tej samej funkcji <code>get_layer_config()</code>, dodaj mapowanie nazw aby system rozpoznawa≈Ç r√≥≈ºne sposoby nazywania warstwy:</p>

<pre><code># Map common names to layer keys
name_mapping = {
    "dzia≈Çki": "parcels",
    "parcels": "parcels", 
    "parcel": "parcels",
    "budynki": "buildings",
    "buildings": "buildings",
    "building": "buildings", 
    "gpz": "gpz",
    "gpz_110kv": "gpz",
    
    # ‚úÖ DODAJ MAPOWANIE DLA NOWEJ WARSTWY
    "drogi": "drogi",
    "roads": "drogi",
    "road": "drogi",
    "sieƒá drogowa": "drogi",
    "ulice": "drogi",
    "streets": "drogi"
}</code></pre>

                <div class="success">
                    <h4><span class="emoji">‚úÖ</span>Po tej zmianie u≈ºytkownicy bƒôdƒÖ mogli u≈ºywaƒá:</h4>
                    <ul>
                        <li>"poka≈º drogi"</li>
                        <li>"wczytaj roads"</li>
                        <li>"wy≈õwietl sieƒá drogowƒÖ"</li>
                        <li>"poka≈º ulice"</li>
                    </ul>
                </div>
            </div>
        </section>

        <section id="krok4">
            <div class="step">
                <h2><span class="step-number">4</span><span class="emoji">üé®</span>Stylowanie w frontend (opcjonalne)</h2>
                
                <div class="file-path">üìÅ frontend/src/mapStyles.ts</div>
                
                <p>Dodaj niestandardowe style dla nowej warstwy:</p>

<pre><code>// Dodaj nowy styl dla dr√≥g
const roadsPathStyle: PathStyleOptions = {
    color: "#ff6600",        // pomara≈Ñczowy dla dr√≥g
    weight: 2,               // grubo≈õƒá linii
    opacity: 0.8,            // przezroczysto≈õƒá
    fillOpacity: 0.1,        // wype≈Çnienie (dla poligon√≥w)
};

// Dodaj styl dla park√≥w (przyk≈Çad)
const parksPathStyle: PathStyleOptions = {
    color: "#228B22",        // zielony dla park√≥w
    weight: 1,
    opacity: 0.7,
    fillOpacity: 0.3,
};

// Zaktualizuj funkcjƒô getPathStyle
export const getPathStyle = (layerName?: string): PathStyleOptions => {
    switch (layerName) {
        case 'parcels':
            return parcelsPathStyle;
        case 'Drogi':           // nazwa z display_name
            return roadsPathStyle;
        case 'Parki':
            return parksPathStyle;
        default:
            return defaultPathStyle;
    }
};</code></pre>

                <div class="highlight">
                    <h4><span class="emoji">üé®</span>Kolory dla r√≥≈ºnych typ√≥w warstw:</h4>
                    <ul>
                        <li><strong>Drogi:</strong> #ff6600 (pomara≈Ñczowy)</li>
                        <li><strong>Parki:</strong> #228B22 (zielony)</li>
                        <li><strong>Woda:</strong> #4169E1 (niebieski)</li>
                        <li><strong>Budynki:</strong> #8B4513 (brƒÖzowy)</li>
                        <li><strong>Granice:</strong> #FF1493 (r√≥≈ºowy)</li>
                    </ul>
                </div>
            </div>
        </section>

        <section id="krok5">
            <div class="step">
                <h2><span class="step-number">5</span><span class="emoji">üöÄ</span>Automatyczne ≈Çadowanie (opcjonalne)</h2>
                
                <div class="file-path">üìÅ frontend/src/App.tsx</div>
                
                <p>Je≈õli chcesz, aby warstwa ≈Çadowa≈Ça siƒô automatycznie przy starcie aplikacji:</p>

<pre><code>const initialLayerNames = [
    { name: 'GPZ 110kV', apiName: 'gpz_110kv', color: '#ff0000' },
    { name: 'Budynki', apiName: 'buildings', color: '#3388ff' },
    { name: 'Dzia≈Çki', apiName: 'parcels', color: '#00ff00' },
    
    // ‚úÖ DODAJ NOWƒÑ WARSTWƒò
    { name: 'Drogi', apiName: 'drogi', color: '#ff6600' },
    { name: 'Parki', apiName: 'parki', color: '#228B22' }
];</code></pre>
            </div>
        </section>

        <section id="przyklad">
            <h2><span class="emoji">üìù</span>7. Przyk≈Çad kompletny - Warstwa "Parki"</h2>
            
            <div class="step">
                <h3>Konfiguracja w GISRepository:</h3>
<pre><code>"parki": LayerConfig(
    name="parki",
    table_name="parks",
    geometry_column="geometry",
    id_column="park_id", 
    display_name="Parki",
    description="Tereny zielone i parki miejskie",
    has_low_resolution=True
)</code></pre>

                <h3>Mapowanie nazw:</h3>
<pre><code>"parki": "parki",
"parks": "parki",
"park": "parki", 
"tereny zielone": "parki",
"ziele≈Ñ": "parki",
"green spaces": "parki"</code></pre>

                <h3>Stylowanie:</h3>
<pre><code>const parksPathStyle: PathStyleOptions = {
    color: "#228B22",
    weight: 1,
    opacity: 0.7,
    fillOpacity: 0.3,
};</code></pre>
            </div>
        </section>

        <section id="testowanie">
            <h2><span class="emoji">üß™</span>8. Testowanie</h2>
            
            <div class="step">
                <h3>Test 1: Sprawd≈∫ dostƒôpno≈õƒá warstwy</h3>
<pre><code># W terminalu backend/
python -c "
from services import GISService
from config.database import engine
service = GISService(engine)
layers = service.get_available_layers()
print('Dostƒôpne warstwy:', list(layers.keys()))
print('Info o nowej warstwie:', layers.get('drogi'))
"</code></pre>

                <h3>Test 2: Test API endpoint</h3>
<pre><code># Uruchom serwer
cd backend
uvicorn main:app --reload

# W przeglƒÖdarce lub curl
curl http://localhost:8000/api/v1/layers/drogi
curl http://localhost:8000/api/v1/layers/roads</code></pre>

                <h3>Test 3: Test zapyta≈Ñ w jƒôzyku naturalnym</h3>
<pre><code># POST http://localhost:8000/api/v1/chat
{
  "query": "poka≈º drogi"
}

{
  "query": "wczytaj warstwƒô dr√≥g"
}

{
  "query": "wy≈õwietl roads"
}</code></pre>
            </div>
        </section>

        <section id="troubleshooting">
            <h2><span class="emoji">üîß</span>9. RozwiƒÖzywanie problem√≥w</h2>
            
            <div class="warning">
                <h4><span class="emoji">‚ö†Ô∏è</span>Czƒôste problemy i rozwiƒÖzania:</h4>
            </div>

            <div class="step">
                <h3>Problem: "Layer not found"</h3>
                <p><strong>Przyczyny:</strong></p>
                <ul>
                    <li>Tabela nie istnieje w bazie danych</li>
                    <li>B≈Çƒôdna nazwa tabeli w konfiguracji</li>
                    <li>Brak uprawnie≈Ñ do tabeli</li>
                </ul>
                <p><strong>RozwiƒÖzanie:</strong></p>
<pre><code># Sprawd≈∫ czy tabela istnieje
SELECT table_name FROM information_schema.tables 
WHERE table_name = 'roads';

# Sprawd≈∫ uprawnienia
GRANT SELECT ON roads TO postgres;</code></pre>
            </div>

            <div class="step">
                <h3>Problem: "Invalid geometry column"</h3>
                <p><strong>Przyczyny:</strong></p>
                <ul>
                    <li>B≈Çƒôdna nazwa kolumny geometrii</li>
                    <li>Kolumna nie jest typu GEOMETRY</li>
                </ul>
                <p><strong>RozwiƒÖzanie:</strong></p>
<pre><code># Sprawd≈∫ kolumny geometrii
SELECT f_table_name, f_geometry_column, type 
FROM geometry_columns 
WHERE f_table_name = 'roads';</code></pre>
            </div>

            <div class="step">
                <h3>Problem: Warstwa nie ≈Çaduje siƒô w frontend</h3>
                <p><strong>Sprawd≈∫:</strong></p>
                <ul>
                    <li>Czy serwer backend dzia≈Ça</li>
                    <li>Czy endpoint zwraca poprawny GeoJSON</li>
                    <li>Czy nie ma b≈Çƒôd√≥w w konsoli przeglƒÖdarki</li>
                    <li>Czy CORS jest poprawnie skonfigurowany</li>
                </ul>
            </div>

            <div class="step">
                <h3>Problem: Zapytania w jƒôzyku naturalnym nie dzia≈ÇajƒÖ</h3>
                <p><strong>Sprawd≈∫:</strong></p>
                <ul>
                    <li>Czy doda≈Çe≈õ mapowanie nazw w <code>name_mapping</code></li>
                    <li>Czy nazwa warstwy jest w <code>self.layers</code></li>
                    <li>Czy klucz w mapowaniu odpowiada kluczowi w layers</li>
                </ul>
            </div>
        </section>

        <div class="success" style="margin-top: 40px;">
            <h3><span class="emoji">üéâ</span>Gratulacje!</h3>
            <p>Po wykonaniu tych krok√≥w Twoja nowa warstwa bƒôdzie w pe≈Çni zintegrowana z systemem Geo-Asystent AI i dostƒôpna przez:</p>
            <ul>
                <li><strong>Zapytania w jƒôzyku naturalnym</strong> (polskim i angielskim)</li>
                <li><strong>Bezpo≈õrednie API</strong> (<code>/api/v1/layers/nazwa</code>)</li>
                <li><strong>Automatyczne ≈Çadowanie</strong> w interfejsie</li>
                <li><strong>Monitorowanie i logowanie</strong> wszystkich operacji</li>
            </ul>
        </div>

        <div style="text-align: center; margin-top: 40px; padding: 20px; background: #f8f9fa; border-radius: 8px;">
            <p><strong>Geo-Asystent AI</strong> | Dokumentacja wygenerowana automatycznie</p>
            <p style="color: #6c757d; font-size: 0.9em;">Wersja: 1.0 | Data: 2025-01-19</p>
        </div>
    </div>
</body>
</html>